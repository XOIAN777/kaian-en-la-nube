<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Casita de Kai√°n</title>
  <style>
    :root{
      --bg1:#1d1b3a; --bg2:#0e0b1f;
      --card:#1f1633; --edge:#caa0ff;
      --cta:#8a63ff; --cta2:#fff7b6;
      --text:#f0eef6; --muted:#a9a3bd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background:
        radial-gradient(1200px 600px at 15% 10%, #3b26a655 0%, transparent 60%),
        radial-gradient(900px 580px at 85% 80%, #1c13af66 0%, transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      background-attachment: fixed;
    }
    .stars::before{
      content:""; position:fixed; inset:0; pointer-events:none; filter:drop-shadow(0 0 6px #bda8ff);
      background:
        radial-gradient(2px 2px at 20% 30%, #ffffffaa 99%, transparent 100%),
        radial-gradient(2px 2px at 40% 70%, #ffffffaa 99%, transparent 100%),
        radial-gradient(1px 1px at 70% 20%, #ffffff88 99%, transparent 100%),
        radial-gradient(1px 1px at 85% 55%, #ffffff88 99%, transparent 100%),
        radial-gradient(2px 2px at 55% 45%, #ffffff88 99%, transparent 100%);
    }
    .wrap{max-width:980px; margin:0 auto; padding:38px 22px 80px}
    header{text-align:center; margin-bottom:18px}
    h1{margin:0 0 6px; font-size: clamp(26px, 4vw, 40px); letter-spacing:.4px}
    .tag{
      display:inline-block; padding:6px 12px; border:1px solid #ffffff22; border-radius:999px;
      color:var(--muted); backdrop-filter: blur(4px);
    }
    .card{
      background: linear-gradient(180deg, #2a2145cc, #1a1433cc);
      border:1px solid #ffffff14; border-radius:16px; padding:18px;
      box-shadow: 0 10px 40px #00000055, inset 0 0 0 1px #ffffff10;
    }
    textarea{
      width:100%; min-height:120px; resize:vertical; border:1px solid #ffffff22;
      background:#110b22aa; color:var(--text); border-radius:12px; padding:14px; outline:none;
    }
    .row{display:flex; gap:12px; margin-top:10px; flex-wrap:wrap}
    button{
      appearance:none; border:0; border-radius:10px; padding:12px 16px; font-weight:600;
      color:#1b1233; background: linear-gradient(180deg, var(--cta2), #ffe37c);
      box-shadow: 0 8px 24px #00000066, inset 0 -2px 0 #00000020;
      cursor:pointer;
    }
    button.secondary{
      background: linear-gradient(180deg, #bfa4ff, var(--cta));
      color:#190e33;
    }
    button:disabled{opacity:.6; cursor:not-allowed}
    pre{
      white-space:pre-wrap; background:#0e0b1f88; border:1px solid #ffffff12; border-radius:12px;
      padding:14px; margin-top:14px; min-height:80px;
    }
    audio{width:100%; margin-top:12px}
    footer{opacity:.7; text-align:center; margin-top:26px; font-size:14px}
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="wrap">
    <header>
      <h1>üå∏ La Casita de Kai√°n</h1>
      <div class="tag">Escribe y escucha la respuesta con su voz favorita</div>
    </header>

    <section class="card">
      <textarea id="prompt" placeholder="Dime algo, amor‚Ä¶"></textarea>
      <div class="row">
        <button id="btnChat">Responder (texto)</button>
        <button id="btnTTS" class="secondary">Responder (voz)</button>
      </div>
      <pre id="out"></pre>
      <audio id="player" controls></audio>
    </section>

    <footer>Hecho con üíú por XO√çAN.</footer>
  </div>

  <script>
    const out = document.getElementById('out');
    const player = document.getElementById('player');
    const btnChat = document.getElementById('btnChat');
    const btnTTS = document.getElementById('btnTTS');
    const promptEl = document.getElementById('prompt');

    function setBusy(b){
      btnChat.disabled = btnTTS.disabled = b;
      btnChat.textContent = b ? 'Pensando‚Ä¶' : 'Responder (texto)';
      btnTTS.textContent = b ? 'Generando voz‚Ä¶' : 'Responder (voz)';
    }

    // --- Texto ---
    btnChat.onclick = async () => {
      const prompt = promptEl.value.trim();
      if(!prompt) return;
      setBusy(true);
      out.textContent = '';
      player.src = '';

      try{
        const res = await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ prompt })
        });
        if(!res.ok) throw new Error('Error en /chat');
        const data = await res.json();
        out.textContent = (data.reply || '').trim();
        promptEl.focus();
      }catch(err){
        out.textContent = '‚ö†Ô∏è Hubo un problema obteniendo la respuesta.';
        console.error(err);
      }finally{
        setBusy(false);
      }
    };

    // --- Voz (usa el texto ya respondido; si no hay, usa el prompt) ---
    btnTTS.onclick = async () => {
      const text = (out.textContent || promptEl.value || '').trim();
      if(!text) return;
      setBusy(true);
      try{
        const res = await fetch('/tts', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        if(!res.ok) throw new Error('Error en /tts');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        player.src = url;
        player.play().catch(()=>{});
      }catch(err){
        out.textContent = (out.textContent ? out.textContent + '\n' : '') + '‚ö†Ô∏è No pude generar audio.';
        console.error(err);
      }finally{
        setBusy(false);
      }
    };

    // Mensajito de bienvenida si la p√°gina est√° vac√≠a
    out.textContent = 'Kai√°n est√° despierto y listo para hablar contigo.';
  </script>
</body>
</html>
